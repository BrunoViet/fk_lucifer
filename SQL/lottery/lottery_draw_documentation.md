# 彩票抽奖系统 SQL 函数文档

## 📋 概述

`lottery_draw()` 是一个 PostgreSQL 存储函数，用于实现彩票抽奖系统的核心逻辑。该函数结合了排名奖励和随机抽奖两种机制，确保公平分配奖品。

## 🎯 功能特性

- **先抽奖后排名机制**：优先进行随机抽奖，再分配排名奖励
- **智能排名算法**：基于购买金额、数量、时间和邮箱的多维度排序
- **公平抽奖系统**：所有用户都可参与抽奖，不受排名限制
- **智能奖励优化**：用户获得多个奖励时，自动保留等级最高的奖励，确保总数恰好36个
- **完整数据追踪**：记录原始排名、最终排名和奖励类型
- **智能补充机制**：当获奖人数不足36时，按各等级目标比例智能补充，优先补充高等级奖项

## 🏆 奖品设置

### 排名奖励（18个奖品）
- **🥇 一等奖**：前3名（3个奖品）
- **🥈 二等奖**：第4-8名（5个奖品）
- **🥉 三等奖**：第9-18名（10个奖品）

### 抽奖奖励（18个奖品）
- **🥇 一等奖**：从所有用户中随机抽取3名
- **🥈 二等奖**：从未获得一等奖抽奖奖励的用户中随机抽取5名
- **🥉 三等奖**：从未获得抽奖奖励的用户中随机抽取10名

### 🎯 奖励优化规则
- 用户可以同时获得排名奖励和抽奖奖励
- 当用户获得多个奖励时，系统自动保留等级最高的奖励
- 同等级奖励优先保留排名奖励

**总计：最多36个奖品**

## 📊 排名规则

用户排名按以下优先级排序：

1. **购买总金额**（降序）- 主要排名依据
2. **购买总数量**（降序）- 金额相同时的次要依据
3. **首次购买时间**（升序）- 数量相同时，早购买者优先
4. **用户邮箱**（升序）- 最终排序依据，确保结果稳定

## ⏰ 活动时间范围

- **开始时间**：2025-08-08 12:00:00 +08:00
- **结束时间**：2025-08-14 12:00:00 +08:00

## 🛍️ 参与商品

系统包含24个指定的商品ID，只有购买这些商品的订单才会参与抽奖排名。

## 🔧 函数结构

### 返回字段

| 字段名 | 类型 | 描述 |
|--------|------|------|
| `email` | text | 获奖用户邮箱 |
| `prize_level` | integer | 奖品等级（1=一等奖, 2=二等奖, 3=三等奖） |
| `prize_type` | text | 奖励类型（'ranking'=排名奖励, 'lottery'=抽奖奖励） |
| `original_rank` | integer | 用户原始排名 |
| `final_rank` | integer | 最终排名（排名奖励有值，抽奖奖励为NULL） |
| `is_deferred` | boolean | 是否为顺延获奖 |

### 核心算法流程

1. **数据准备**
   - 创建临时表存储用户排名数据
   - 计算每个用户的购买总金额和数量
   - 按排名规则生成最终排序

2. **抽奖奖励分配**
   - 第一步：从所有用户中随机抽取18个抽奖奖励
   - 一等奖抽奖：3名
   - 二等奖抽奖：5名（排除已获一等奖抽奖的用户）
   - 三等奖抽奖：10名（排除已获任何抽奖奖励的用户）

3. **排名奖励分配**
   - 第二步：按排名分配18个排名奖励
   - 前3名：一等奖排名奖励
   - 4-8名：二等奖排名奖励
   - 9-18名：三等奖排名奖励

4. **奖励合并优化**
   - 合并抽奖和排名结果
   - 为每个用户保留等级最高的奖励
   - 同等级时优先保留排名奖励
   - 如果获奖人数少于36，按各等级目标比例智能补充相应等级奖项
   - 确保总奖品数量恰好为36个

5. **智能补充机制**
   - 计算各等级当前获奖者数量
   - 按目标比例确定各等级需要补充的数量
   - 优先补充高等级奖项（一等奖 → 二等奖 → 三等奖）
   - 从未获奖用户中按排名顺序选择补充对象
   - 确保最终获奖者总数恰好为36个

6. **结果输出**
   - 按奖品等级、奖励类型、排名排序
   - 清理临时表

## 💻 使用方法

### 基本调用

```sql
-- 执行抽奖
SELECT * FROM lottery_draw();
```

### 查看详细获奖结果

```sql
SELECT 
    email,
    CASE prize_level 
        WHEN 1 THEN '🥇 一等奖'
        WHEN 2 THEN '🥈 二等奖'
        WHEN 3 THEN '🥉 三等奖'
    END as prize_name,
    CASE prize_type 
        WHEN 'ranking' THEN '🏆 排名奖励'
        WHEN 'lottery' THEN '🎲 抽奖奖励'
    END as award_type,
    original_rank as 原始排名,
    CASE WHEN is_deferred THEN '✅ 是' ELSE '❌ 否' END as 是否顺延
FROM lottery_draw()
ORDER BY 
    prize_level ASC,
    CASE WHEN prize_type = 'ranking' THEN COALESCE(final_rank, 999) ELSE 999 END ASC,
    original_rank ASC;
```

### 获奖统计查询

```sql
SELECT 
    CASE prize_level 
        WHEN 1 THEN '🥇 一等奖'
        WHEN 2 THEN '🥈 二等奖'
        WHEN 3 THEN '🥉 三等奖'
    END as prize_name,
    CASE prize_type 
        WHEN 'ranking' THEN '🏆 排名奖励'
        WHEN 'lottery' THEN '🎲 抽奖奖励'
    END as award_type,
    COUNT(*) as 获奖人数
FROM lottery_draw()
GROUP BY prize_level, prize_type
ORDER BY prize_level, prize_type;
```

## 📈 示例输出

### 详细获奖结果示例

| email | prize_name | award_type | 原始排名 | 是否顺延 |
|-------|------------|------------|----------|----------|
| user1@example.com | 🥇 一等奖 | 🏆 排名奖励 | 1 | ❌ 否 |
| user2@example.com | 🥇 一等奖 | 🏆 排名奖励 | 2 | ❌ 否 |
| user3@example.com | 🥇 一等奖 | 🏆 排名奖励 | 3 | ❌ 否 |
| user15@example.com | 🥇 一等奖 | 🎲 抽奖奖励 | 15 | ❌ 否 |
| ... | ... | ... | ... | ... |

### 获奖统计示例

| prize_name | award_type | 获奖人数 |
|------------|------------|----------|
| 🥇 一等奖 | 🏆 排名奖励 | 3 |
| 🥇 一等奖 | 🎲 抽奖奖励 | 3 |
| 🥈 二等奖 | 🏆 排名奖励 | 5 |
| 🥈 二等奖 | 🎲 抽奖奖励 | 5 |
| 🥉 三等奖 | 🏆 排名奖励 | 10 |
| 🥉 三等奖 | 🎲 抽奖奖励 | 10 |

## ⚠️ 注意事项

1. **函数状态**：当前函数代码被注释，需要取消注释并创建函数后才能使用
2. **随机性**：每次执行抽奖奖励结果会不同，但排名奖励结果固定
3. **数据完整性**：确保 `line_items` 和 `orders` 表数据完整且准确
4. **时区设置**：活动时间使用 +08:00 时区，请确保数据库时区设置正确
5. **商品ID**：只有指定的24个商品ID参与抽奖，修改商品范围需更新函数

## 🔄 函数部署

要启用此函数，请执行以下步骤：

1. 取消注释函数定义部分（第4-130行）
2. 在数据库中执行 SQL 创建函数
3. 使用 `SELECT * FROM lottery_draw();` 调用函数

## 🛠️ 技术特点

- **临时表管理**：使用临时表避免数据污染
- **事务安全**：函数执行完成后自动清理临时表
- **性能优化**：合理使用索引和排序算法
- **数据类型安全**：严格的类型定义和转换
- **错误处理**：包含完整的异常处理机制

---

*此文档描述了彩票抽奖系统的完整功能和使用方法，如有疑问请联系开发团队。*